name: Slash /sync-live-here (rebase feature onto LIVE snapshot)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: sync-live-here-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  rebase-onto-live:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/sync-live-here')
    runs-on: ubuntu-latest
    steps:
      - name: Guard – allow org member/collaborator only
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const commenter = context.payload.comment.user.login;
            let ok = false;
            try { await github.rest.orgs.checkMembershipForUser({ org: owner, username: commenter }); ok = true; } catch {}
            if (!ok) { try { await github.rest.repos.checkCollaborator({ owner, repo, username: commenter }); ok = true; } catch {} }
            if (!ok) core.setFailed(`User @${commenter} is not allowed to run /sync-live-here`);

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({ ...context.repo, pull_number: context.payload.issue.number });
            core.setOutput('headRef',  pr.data.head.ref);
            core.setOutput('headRepo', pr.data.head.repo.full_name);
            core.setOutput('baseRef',  pr.data.base.ref);
            core.setOutput('baseRepo', pr.data.base.repo.full_name);

      - name: Checkout PR head (write-enabled)
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.headRepo }}
          ref: ${{ steps.pr.outputs.headRef }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node & Shopify CLI
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g @shopify/cli @shopify/theme

      - name: Configure Shopify auth (echo only)
        env:
          SHOPIFY_FLAG_STORE: ${{ vars.SHOPIFY_FLAG_STORE }}
          SHOPIFY_FLAG_PATH: ${{ vars.SHOPIFY_FLAG_PATH }}
        run: |
          echo "Store: ${SHOPIFY_FLAG_STORE}"
          echo "Path : ${SHOPIFY_FLAG_PATH:-theme}"

      - name: Compute merge-base with base branch
        id: base
        run: |
          set -e
          if ! git remote | grep -q '^upstream$'; then
            git remote add upstream https://github.com/${{ steps.pr.outputs.baseRepo || github.repository }}.git
          fi
          git fetch --no-tags --prune upstream ${{ steps.pr.outputs.baseRef }}:refs/remotes/upstream/${{ steps.pr.outputs.baseRef }}
          BASE=$(git merge-base HEAD refs/remotes/upstream/${{ steps.pr.outputs.baseRef }})
          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "Merge-base: $BASE"
          echo "Commits ahead of base: $(git rev-list --count $BASE..HEAD)"

      - name: Configure Git author (commenter)
        run: |
          git config --local user.name  "${{ github.event.comment.user.login }}"
          git config --local user.email "${{ github.event.comment.user.login }}@users.noreply.github.com"

      - name: Create LIVE snapshot from base & pull LIVE
        id: snap
        env:
          SHOPIFY_FLAG_STORE: emma-greg-dev-store.myshopify.com
          SHOPIFY_FLAG_PATH: theme
          SHOPIFY_CLI_THEME_TOKEN: shptka_ac06aad8ca02547f088c4b35ebaed0ab
        run: |
          set -e
          # checkout snapshot from upstream/<baseRef>
          git checkout -B live-snapshot refs/remotes/upstream/${{ steps.pr.outputs.baseRef }}

          # clean ONLY the theme directory
          THEME_DIR="${SHOPIFY_FLAG_PATH:-theme}"
          mkdir -p "$THEME_DIR"
          rm -rf "$THEME_DIR"/* "$THEME_DIR"/.[!.]* "$THEME_DIR"/..?* || true

          # pull LIVE into THEME_DIR
          shopify theme pull \
            --store "$SHOPIFY_FLAG_STORE" \
            --password "$SHOPIFY_CLI_THEME_TOKEN" \
            --path "$THEME_DIR" \
            --force \
            --live

          # no-op if nothing changed
          if [ -z "$(git status --porcelain)" ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git add -A
          git commit -m "chore(live): snapshot from LIVE $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "no_changes=false" >> $GITHUB_OUTPUT

      - name: Switch back to feature branch for scan
        run: git checkout ${{ steps.pr.outputs.headRef }}

      - name: Find last LIVE snapshot commit on this branch (if any)
        id: last_snap
        run: |
          BR="${{ steps.pr.outputs.headRef }}"
          LAST=$(git log "$BR" --grep='^chore(live): snapshot from LIVE' --format=%H -n1 || true)
          echo "last=$LAST" >> $GITHUB_OUTPUT
          if [ -n "$LAST" ]; then
            echo "Found last LIVE snapshot on $BR: $LAST"
            echo "Commits since last snapshot:"
            git log --oneline "$LAST".."$BR" || true
          else
            echo "No previous snapshot on $BR; will use merge-base."
            echo "Commits since merge-base:"
            git log --oneline ${{ steps.base.outputs.base }}.."$BR" || true
          fi

      - name: Rebase PR commits onto LIVE snapshot (drop old snapshots)
        if: steps.snap.outputs.no_changes == 'false'
        run: |
          set -e
          BR="${{ steps.pr.outputs.headRef }}"
          START="${{ steps.last_snap.outputs.last }}"
          if [ -z "$START" ] || [ "$START" = "null" ]; then
            START="${{ steps.base.outputs.base }}"
          fi

          AHEAD=$(git rev-list --count "$START".."$BR")
          echo "Commits to replay: $AHEAD"

          if [ "$AHEAD" -eq 0 ]; then
            echo "No commits after last snapshot. Fast-updating branch to live-snapshot."
            git checkout "$BR"
            git reset --hard live-snapshot
          else
            export GIT_SEQUENCE_EDITOR='bash -c "sed -E -i '\''/^[a-z]+ [0-9a-f]+ .*chore\\(live\\): snapshot from LIVE/d'\'' \"$1\""'
            git checkout "$BR"
            git rebase --rebase-merges --reapply-cherry-picks --empty=keep \
              --onto live-snapshot "$START" "$BR"
          fi

          echo "After rewrite:"
          git log --oneline -n 20

      - name: Push back (force-with-lease)
        if: steps.snap.outputs.no_changes == 'false'
        run: |
          git push --force-with-lease origin HEAD:${{ steps.pr.outputs.headRef }}

      - name: Add label synced-live (optional)
        if: always()
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: synced-live

      - name: Comment result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const noChanges = '${{ steps.snap.outputs.no_changes }}' === 'true';
            const ts = new Date().toISOString();
            const body = noChanges
              ? `ℹ️ \`/sync-live-here\` at **${ts}** (UTC): LIVE has no changes relative to base. Rebase skipped.`
              : `✅ \`/sync-live-here\` at **${ts}** (UTC): Rebased this branch on top of the latest **LIVE snapshot** (old snapshots removed).`;
            await github.rest.issues.createComment({ ...context.repo, issue_number: context.payload.issue.number, body })
