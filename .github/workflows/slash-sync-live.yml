name: Slash /sync-live-here (rebase feature onto LIVE snapshot)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: sync-live-here-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  rebase-onto-live:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/sync-live-here')
    runs-on: ubuntu-latest
    steps:
      - name: Guard ‚Äì allow org member/collaborator only
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const commenter = context.payload.comment.user.login;
            let ok = false;
            try { await github.rest.orgs.checkMembershipForUser({ org: owner, username: commenter }); ok = true; } catch {}
            if (!ok) { try { await github.rest.repos.checkCollaborator({ owner, repo, username: commenter }); ok = true; } catch {} }
            if (!ok) core.setFailed(`User @${commenter} is not allowed to run /sync-live-here`);

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({ ...context.repo, pull_number: context.payload.issue.number });
            core.setOutput('headRef', pr.data.head.ref);
            core.setOutput('headRepo', pr.data.head.repo.full_name);
            core.setOutput('baseRef', pr.data.base.ref);
            core.setOutput('baseRepo', pr.data.base.repo.full_name);

      - name: Checkout PR head (write-enabled)
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.headRepo }}
          ref: ${{ steps.pr.outputs.headRef }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # üëà FULL HISTORY ƒë·ªÉ merge-base ch√≠nh x√°c

      - name: Setup Node & Shopify CLI
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g @shopify/cli @shopify/theme

      - name: Configure Shopify auth
        env:
          SHOPIFY_FLAG_STORE: emma-dev.myshopify.com
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
        run: echo "Store $SHOPIFY_FLAG_STORE"

      - name: Compute merge-base with base branch
        id: base
        run: |
          set -e
          # add upstream = base repo n·∫øu ch∆∞a c√≥
          if ! git remote | grep -q '^upstream$'; then
            git remote add upstream https://github.com/${{ steps.pr.outputs.baseRepo || github.repository }}.git
          fi
          git fetch --no-tags --prune upstream ${{ steps.pr.outputs.baseRef }}:refs/remotes/upstream/${{ steps.pr.outputs.baseRef }}
          BASE=$(git merge-base HEAD refs/remotes/upstream/${{ steps.pr.outputs.baseRef }})
          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "Merge-base: $BASE"
          echo "Commits ahead of base: $(git rev-list --count $BASE..HEAD)"

      - name: Configure Git author (commenter)
        uses: actions/github-script@v7
        with:
          script: |
            const name = context.payload.comment.user.login;
            const email = `${name}@users.noreply.github.com`;
            core.info(`Setting git author to ${name} <${email}>`);
            await exec.exec('git', ['config', '--local', 'user.name', name]);
            await exec.exec('git', ['config', '--local', 'user.email', email]);
      - name: Create LIVE snapshot from base & pull LIVE
        id: snap
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
        run: |
          set -e
          # checkout snapshot t·ª´ upstream/<baseRef>
          git checkout -B live-snapshot refs/remotes/upstream/${{ steps.pr.outputs.baseRef }}

          # d·ªçn CH·ªà th∆∞ m·ª•c theme/
          mkdir -p theme
          rm -rf theme/* theme/.[!.]* theme/..?* || true

          # k√©o LIVE v√†o ./theme
          shopify theme pull --store "emma-greg-dev-store.myshopify.com" --path "theme" --password "shptka_ac06aad8ca02547f088c4b35ebaed0ab" --force --live

          # n·∫øu kh√¥ng c√≥ thay ƒë·ªïi th√¨ no-op
          if [ -z "$(git status --porcelain)" ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # commit ch·ªâ thay ƒë·ªïi trong theme/
          git add -A
          git commit -m "chore(live): snapshot from LIVE $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "no_changes=false" >> $GITHUB_OUTPUT

      - name: Find last LIVE snapshot commit on this branch (if any)
        id: last_snap
        run: |
          # T√¨m commit g·∫ßn nh·∫•t c√≥ message "chore(live): snapshot from LIVE ..."
          LAST=$(git log --grep='^chore(live): snapshot from LIVE' --format=%H -n1 || true)
          echo "last=$LAST" >> $GITHUB_OUTPUT
          if [ -n "$LAST" ]; then
            echo "Found last LIVE snapshot: $LAST"
            echo "Commits since last snapshot:"
            git log --oneline $LAST..HEAD || true
          else
            echo "No previous snapshot found; will use merge-base."
            echo "Commits since merge-base:"
            git log --oneline ${{ steps.base.outputs.base }}..HEAD || true
          fi

      - name: Rebase PR commits onto LIVE snapshot (keep commit count)
        if: steps.snap.outputs.no_changes == 'false'
        run: |
          set -e
          git checkout ${{ steps.pr.outputs.headRef }}

          # N·∫øu ƒë√£ t·ª´ng snapshot: ch·ªâ re-apply c√°c commit SAU snapshot g·∫ßn nh·∫•t
          START="${{ steps.last_snap.outputs.last }}"
          if [ -z "$START" ] || [ "$START" = "null" ]; then
            START="${{ steps.base.outputs.base }}"
          fi

          # Gi·ªØ merge graph, re-apply cherry-picks, v√† gi·ªØ commit r·ªóng n·∫øu c·∫ßn
          git rebase --rebase-merges --reapply-cherry-picks --empty=keep \
            --onto live-snapshot "$START" ${{ steps.pr.outputs.headRef }}

          echo "After rebase:"
          git log --oneline -n 20

      - name: Push back (force-with-lease)
        if: steps.snap.outputs.no_changes == 'false'
        run: |
          git push --force-with-lease origin HEAD:${{ steps.pr.outputs.headRef }}

      - name: Add label synced-live (optional)
        if: always()
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: synced-live

      - name: Comment result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const noChanges = '${{ steps.snap.outputs.no_changes }}' === 'true';
            const ts = new Date().toISOString();
            const body = noChanges
              ? `‚ÑπÔ∏è \`/sync-live-here\` at **${ts}** (UTC): LIVE has no changes relative to base. Rebase skipped.`
              : `‚úÖ \`/sync-live-here\` at **${ts}** (UTC): Rebased this branch on top of the latest **LIVE snapshot**.`;
            await github.rest.issues.createComment({ ...context.repo, issue_number: context.payload.issue.number, body })
